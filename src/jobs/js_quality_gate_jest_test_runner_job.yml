description: Runs jest tests with CircleCI parallelism
executor: js
parameters:
  resource_class:
    type: string
    default: medium+
  script:
    type: string
  globPattern:
    type: string
  parallelism:
    type: integer
    default: 4
resource_class: << parameters.resource_class >>
parallelism: << parameters.parallelism >>
steps:
  - checkout
  - js_dependencies_restore_from_cache
  - run:
      name: Running tests
      command: |
        shopt -s globstar # This is to make sure that ** is understood as pattern when globbing, e.g. /src/**/*.test.ts
        circleci tests glob << parameters.globPattern >> | circleci tests split --split-by=timings > testing/tmp-test-list
        yarn << parameters.script >>
      environment:
        JEST_JUNIT_OUTPUT_DIR: ./reports/junit
        JEST_JUNIT_ADD_FILE_ATTRIBUTE: 'true'
  - store_test_results:
      path: ./reports/junit
  - store_artifacts:
      path: ./reports/junit
