description: >
  Build and push docker image of java app using isopod (leveraging prebuilt sources from caches and workspace).
  Supports app-module from monorepo as well as single app from single-app-repo.

parameters:
  appname:
    description: "Name of maven module for the app, or blank for single-app-repo"
    type: string
    default: ""
  prebuild_steps:
    description: "Steps that will run before build"
    type: steps
    default: [ ]
  postbuild_steps:
    description: "Steps that will run after build"
    type: steps
    default: [ ]
  docker_hub_username:
    type: string
    default: $DOCKER_HUB_USERNAME
  docker_hub_password:
    type: string
    default: $DOCKER_HUB_PASSWORD
  private_hub_username:
    type: string
    default: $DOCKER_JFROG_USERNAME
  private_hub_password:
    type: string
    default: $DOCKER_JFROG_PASSWORD
  private_hub_url:
    type: string
    default: $DOCKER_JFROG_REGISTRY_URL
  isopod_version:
    type: string
    default: $ISOPOD_VERSION
  docker_version:
    type: string

executor:
  name: isopod
  tag: << parameters.isopod_version >>
  username: << parameters.private_hub_username >>
  password: << parameters.private_hub_password >>

steps:
  - checkout
  - maven_auth
  - setup_remote_docker:
      docker_layer_caching: false
      version: << parameters.docker_version >>
  - login_docker_registry:
      username: << parameters.docker_hub_username >>
      password: << parameters.docker_hub_password >>
  - login_docker_registry:
      url: << parameters.private_hub_url >>
      username: << parameters.private_hub_username >>
      password: << parameters.private_hub_password >>
  - attach_workspace:
      at: .
  - steps: << parameters.prebuild_steps >>
  - java_isopod_build:
      appname: << parameters.appname >>
  - steps: << parameters.postbuild_steps >>
