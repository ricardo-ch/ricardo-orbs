description: >
  Job for deploying to GKE cluster for environment(dev|prod).

executor:
  name: isopod
  tag: <<parameters.isopod_version>>
  username: <<parameters.private_hub_username>>
  password: <<parameters.private_hub_password>>

parameters:
  path:
    description: 'Path to directory containing isopod.yml file'
    type: string
    default: .
  env:
    description: 'Kubernetes cluster to deploy to'
    type: enum
    enum: [ 'dev', 'prod']
    default: 'dev'
  isopod_version:
    type: string
    default: $ISOPOD_VERSION
  private_hub_username:
    type: string
    default: $DOCKER_JFROG_USERNAME
  private_hub_password:
    type: string
    default: $DOCKER_JFROG_PASSWORD
  predeploy_steps:
    description: 'Steps that will run before deploy process'
    type: steps
    default: [ ]
  deploy_steps:
    description: 'Steps that will run deploy procedure'
    type: steps
    default:
      - deploy:
          config: << parameters.path >>/isopod.yml
          to: <<parameters.env>>
          work_dir: << parameters.work_dir >>
  postdeploy_steps:
    description: 'Steps that will run after deploy process'
    type: steps
    default: [ ]
  slack_notify_success:
    description: 'Flag to trigger sending slack notification on success'
    type: boolean
    default: false
  slack_ok_webhook:
    type: string
    default: $SLACK_WEBHOOK
  slack_ok_branches:
    description: 'Comma separated list of branches for which notifications are sent'
    type: string
    default: 'master'
  slack_notify_failure:
    description: 'Flag to trigger sending slack notification on failure'
    type: boolean
    default: false
  slack_fail_webhook:
    type: string
    default: $SLACK_WEBHOOK
  slack_fail_branches:
    description: 'Comma separated list of branches for which notifications are sent'
    type: string
    default: 'master'
  work_dir:
    type: string
    default: .

steps:
  - checkout
  - steps: << parameters.predeploy_steps >>
  - steps: << parameters.deploy_steps >>
  - steps: << parameters.postdeploy_steps >>
  - when:
      condition: << parameters.slack_notify_success >>
      steps:
        - slack_success:
            branches: << parameters.slack_ok_branches >>
            webhook: << parameters.slack_ok_webhook >>
  - when:
      condition: << parameters.slack_notify_failure >>
      steps:
        - slack_failure:
            branches: << parameters.slack_fail_branches >>
            webhook: << parameters.slack_fail_webhook >>
