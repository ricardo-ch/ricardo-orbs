description: >
  Publish npm module

# Executor

executor: << parameters.e >>

# Parameters

parameters:
  before-publish:
    default: []
    description: Steps to run before publish. Should be removed once all our apps will be migrated to yarn-3.
    type: steps
  e:
    default: js_16
    type: executor
  fingerprints:
    description: SSH key fingerprint
    type: string
  publish-with:
    default: np
    description: Which tool should be used to publish. This is temporary param and will be removed once we get rid of np module from all our apps
    enum: ["np", "custom"]
    type: enum

# Execution

steps:
  - checkout
  - add_ssh_keys:
      fingerprints:
        - << parameters.fingerprints >>
  - steps: << parameters.before-publish >>
  - attach_workspace:
      at: .
  - run:
      command: |
        lastCommitTitle=$(git log -1 --pretty="%s")
        version=$(echo "$lastCommitTitle" | awk -F ':' '{ print tolower($1) }' | grep -Eo '^(patch|minor|major)' || true)
        echo "VERSION_VAR=$version" >> "$BASH_ENV"
        if [ -z "$version" ]
        then
          echo "No version detected. Make sure your last commit starts with patch|minor|major."
          echo "Last commit title: '$lastCommitTitle'"
        else
          echo "Last commit: $lastCommitTitle"
          echo "New '$version' version will be published..."
        fi
      name: Try to extract version from last commit
  - when:
      condition:
        equal: [np, << parameters.publish-with >>]
      steps:
        - run:
            command: |
              if [ -z "$VERSION_VAR" ]
              then
                echo "There will be no publish, semver was not detected"
              else
                echo "Publishing $VERSION_VAR version"
                yarn np $VERSION_VAR --yolo --contents=build --no-release-draft
              fi
            name: Publish version
  - when:
      condition:
        not:
          equal: [np, << parameters.publish-with >>]
      steps:
        - run:
            command: |
              git config --global user.name `git log -1 --pretty=format:'%an'`
              git config --global user.email `git log -1 --pretty=format:'%ae'`
            name: Configure Git user.name and user.email based on last commit
        - run:
            # NPM_GHP_TOKEN was generated for ricardo-saas user
            command: |
              npm set registry https://npm.pkg.github.com/
              echo "//npm.pkg.github.com/:_authToken=$NPM_GHP_TOKEN" > ~/.npmrc
            name: Github Registry authentication
        - run:
            command: |
              if [ -z "$VERSION_VAR" ]
              then
                echo "There will be no publish, semver was not detected"
              else
                echo "Publishing $VERSION_VAR version"
                npm version $VERSION_VAR
                npm publish
              fi
            name: publish npm
        - run:
            command: |
              if [ -z "$VERSION_VAR" ]
              then
                echo "no push, semver was not detected"
              else
                git push --follow-tags --set-upstream origin `git branch --show-current`
              fi
            name: git push version commit and tags
