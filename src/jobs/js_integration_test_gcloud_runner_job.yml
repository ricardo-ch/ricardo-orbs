description: >
  Runs Cypress integration tests in gcloud, used for testing deployed, it's not parallelized.
  To be verified if it can be replaced with canary releases.

executor:
  name: cypress_with_gcloud
  username: $DOCKER_GAR_USERNAME
  password: $DOCKER_GAR_PASSWORD

steps:
  - checkout
  - run:
      name: Installing dependencies
      command: yarn
  - auth_gke
  - gke_port_forward:
      context: ${GKE_CLUSTER_NAME}
      namespace: << parameters.namespace >>
      target: << parameters.target >>
      port: << parameters.port >>
  - run:
      name: Run integration tests
      command: yarn << parameters.test_command >>
  # videos are always stored
  - store_artifacts:
      path: integration/beta/cypress/videos
  # screenshots are only stored, when error occurs
  - store_artifacts:
      path: integration/beta/cypress/screenshots

parameters:
  port:
    type: integer
    default: 3000
  namespace:
    type: string
    default: 'listing'
  target:
    type: string
    default: 'svc/listing-form-spa-svc'
  test_command:
    type: string
    default: cypress:test-beta
